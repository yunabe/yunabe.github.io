
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
<meta content="width=device-width, initial-scale=1" name="viewport" />
<title>Pysh: シェルスクリプトをPythonで書く</title>
    
    <link rel="stylesheet" href="_static/main.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="yunabe 0.1 documentation" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="index.html">yunabe 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Pysh: シェルスクリプトをPythonで書く</a><ul>
<li><a class="reference internal" href="#id2">特徴</a></li>
<li><a class="reference internal" href="#id3">使い方</a><ul>
<li><a class="reference internal" href="#id4">インストール</a></li>
<li><a class="reference internal" href="#id5">ファイルから実行</a></li>
<li><a class="reference internal" href="#id6">標準入力から実行</a></li>
<li><a class="reference internal" href="#id7">引数から実行</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">機能</a><ul>
<li><a class="reference internal" href="#id9">変数参照</a></li>
<li><a class="reference internal" href="#python">Python式</a></li>
<li><a class="reference internal" href="#id10">パイプ</a></li>
<li><a class="reference internal" href="#id11">リダイレクション</a></li>
<li><a class="reference internal" href="#id12">&amp;&amp; || ;</a></li>
<li><a class="reference internal" href="#id13">文字列リテラル</a></li>
<li><a class="reference internal" href="#id14">バッククオート</a></li>
<li><a class="reference internal" href="#id15">バックスラッシュ文字による行継続</a></li>
<li><a class="reference internal" href="#id16">コメント</a></li>
<li><a class="reference internal" href="#map-filter-reduce">map filter reduce</a></li>
<li><a class="reference internal" href="#id17">リターンコードの保存</a></li>
<li><a class="reference internal" href="#id18">Pythonへのリダイレクション</a></li>
<li><a class="reference internal" href="#echo">echo</a></li>
<li><a class="reference internal" href="#id19">組み込みコマンド をPythonで実装する</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/pysh_overview.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pysh-python">
<h1><a class="toc-backref" href="#id20">Pysh: シェルスクリプトをPythonで書く</a><a class="headerlink" href="#pysh-python" title="Permalink to this headline">¶</a></h1>
<p>Pysh はシェルスクリプトをPythonで記述するためのプログラムです。</p>
<p>Pysh を利用すると、コマンドの実行やリダイレクションやパイプといったシェルスクリプトの
便利な機能を Python スクリプトの中で簡単に利用できるようになり、
Python をシェルスクリプトの代わりとしてより利用しやすくなります。
Python 使いならばもはやシェルスクリプトを書く理由は何もありません(Windows以外)。</p>
<div class="contents topic" id="id1">
<p class="topic-title first">詳細</p>
<ul class="simple">
<li><a class="reference internal" href="#pysh-python" id="id20">Pysh: シェルスクリプトをPythonで書く</a><ul>
<li><a class="reference internal" href="#id2" id="id21">特徴</a></li>
<li><a class="reference internal" href="#id3" id="id22">使い方</a><ul>
<li><a class="reference internal" href="#id4" id="id23">インストール</a></li>
<li><a class="reference internal" href="#id5" id="id24">ファイルから実行</a></li>
<li><a class="reference internal" href="#id6" id="id25">標準入力から実行</a></li>
<li><a class="reference internal" href="#id7" id="id26">引数から実行</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8" id="id27">機能</a><ul>
<li><a class="reference internal" href="#id9" id="id28">変数参照</a></li>
<li><a class="reference internal" href="#python" id="id29">Python式</a></li>
<li><a class="reference internal" href="#id10" id="id30">パイプ</a></li>
<li><a class="reference internal" href="#id11" id="id31">リダイレクション</a></li>
<li><a class="reference internal" href="#id12" id="id32">&amp;&amp; || ;</a></li>
<li><a class="reference internal" href="#id13" id="id33">文字列リテラル</a></li>
<li><a class="reference internal" href="#id14" id="id34">バッククオート</a></li>
<li><a class="reference internal" href="#id15" id="id35">バックスラッシュ文字による行継続</a></li>
<li><a class="reference internal" href="#id16" id="id36">コメント</a></li>
<li><a class="reference internal" href="#map-filter-reduce" id="id37">map filter reduce</a></li>
<li><a class="reference internal" href="#id17" id="id38">リターンコードの保存</a></li>
<li><a class="reference internal" href="#id18" id="id39">Pythonへのリダイレクション</a></li>
<li><a class="reference internal" href="#echo" id="id40">echo</a></li>
<li><a class="reference internal" href="#id19" id="id41">組み込みコマンド をPythonで実装する</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id21">特徴</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Pysh では Python スクリプトの中に含まれている <tt class="docutils literal"><span class="pre">&gt;</span></tt> で始まる行をシェルコマンドとして実行します。
それ以外の部分は通常の Python スクリプトとして処理されます。
例えば次のスクリプトはfrom00.txt, from01.txt, ..., from99.txt を to00.txt...to99.txt に移動します。</p>
<div class="highlight-python"><div class="highlight"><pre>for i in xrange(100):
  index = &quot;%02d&quot; % i
  &gt; mv from$index.txt to$index.txt
</pre></div>
</div>
<p>Pysh は次のような特徴を持ちます</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">&gt;</span></tt> で始まる行をシェルコマンドとして実行できる。</li>
<li>シェルコマンドの中から <strong>Pythonの変数</strong> がシェルスクリプトと同じように <tt class="docutils literal"><span class="pre">$var</span></tt> のように参照できる。</li>
<li>パイプやリダイレクションも利用可能</li>
<li>if, for文などはシェルコマンドの中では利用できない。プログラムの制御はPythonで行う。</li>
<li>フィルタ系組み込み関数 map, filter, reduce がコマンドとして利用できる。
grep, sed, awk を利用しなくても柔軟なフィルタリング・置換・変形が行える。</li>
<li>組み込みコマンドを Python で書くことができる。</li>
<li>Pythonで書かれたコマンドは入出力をPythonオブジェクトとして扱うことができる。</li>
<li>またPythonオブジェクトのまま、出力を他のコマンドにパイプすることができる</li>
</ul>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id22">使い方</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id23">インストール</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>GitHubからソースコードをチェックアウトします。
Pysh は Python で実装されているので Python がインストールされている環境ならば
簡単に実行できます。ただしWindowsはサポート外です。
pysh はスクリプトファイルをファイル・標準入力・引数のいずれかで与えて実行することができます。</p>
<div class="highlight-python"><div class="highlight"><pre>git checkout https://github.com/yunabe/pysh.git
./pysh/bin/pysh&lt;/pre&gt;
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id24">ファイルから実行</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>python コマンドと同様に、pyshの引数としてファイルを与えるとファイルをpyshスクリプトとして
解釈し実行します。
pysh コマンドは与えられたファイルを通常の Python スクリプトに変換し Python として実行を行います。
そのため実行後、スクリプト名と同名の拡張子が .py のファイルが残ります。</p>
<div class="highlight-python"><div class="highlight"><pre>pysh script.pysh
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id25">標準入力から実行</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>python コマンドと同様に、pyshの引数として``-`` を与えると
標準入力からpyshスクリプトを読み込み実行します。
この機能はpyshをワンライナーの代わりに利用する際に重宝します。
複雑で読みづらいワンライナーを書くぐらいなら Python で構造化されたプログラムを書きましょう。
構造化されたスクリプトはワンライナーよりも遥かに読みやすく、将来再利用することができます。</p>
<div class="highlight-python"><div class="highlight"><pre>pysh - &lt;&lt; &#39;EOF&#39;
for i in xrange(3):
  index = &quot;%02d&quot; % i
  &gt; echo $index
EOF
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id26">引数から実行</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>python コマンドと同様に、pyshの引数として <tt class="docutils literal"><span class="pre">-c</span> <span class="pre">cmd</span></tt> を与えると <tt class="docutils literal"><span class="pre">cmd</span></tt> をスクリプトとして解釈、実行します。</p>
<div class="highlight-python"><div class="highlight"><pre>pysh -c &quot;`cat &lt;&lt; &#39;EOF&#39;
for i in xrange(3):
  index = &quot;%02d&quot; % i
  &gt; echo $index
EOF`&quot;&lt;/pre&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id27">機能</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id28">変数参照</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">$var</span></tt> でPythonの変数をシェルコマンドの中から参照することができます。
環境変数も <tt class="docutils literal"><span class="pre">$PATH</span></tt> のように Python の変数と同じように参照できます。
また他のシェルと同様に <tt class="docutils literal"><span class="pre">&quot;&quot;</span></tt> で囲まれた文字列中の変数は自動的に展開されます。
<tt class="docutils literal"><span class="pre">''</span></tt> で囲まれた文字列中の変数は展開されません。</p>
<div class="highlight-python"><div class="highlight"><pre>x = 3
y = x * x
&gt; echo $y     # 9
&gt; echo $PATH  # os.environment[&#39;PATH&#39;]
&gt; echo &quot;$x * $x = $y&quot;  # 3 * 3 = 9
&gt; echo &#39;$x * $x = $y&#39;  # $x * $x = $y
</pre></div>
</div>
</div>
<div class="section" id="python">
<h3><a class="toc-backref" href="#id29">Python式</a><a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h3>
<p>Pyshでは変数だけでなく任意の Python 式をシェルコマンドの中で利用することができます。
シェルコマンドの中でPython式を書くには&lt;code&gt;${expr}&lt;/code&gt;のように書きます。
変数参照と同様に、 <tt class="docutils literal"><span class="pre">&quot;&quot;</span></tt> 文字列中のPython式は評価されますが
<tt class="docutils literal"><span class="pre">''</span></tt> 文字列中のPython式は評価されません。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; echo ${3 + 4}  # 7
def f(x):
  return x * x
&gt; echo ${f(10)}  # 100
&gt; echo ${lambda x: x}
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id30">パイプ</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Pysh ではその他のシェルと同じようにコマンドの入出力をパイプ <tt class="docutils literal"><span class="pre">|</span></tt> でつなぐことができます</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; echo &quot;foo\nbar&quot; | tac
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id31">リダイレクション</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>Pysh ではリダイレクションを使ってコマンドの出力結果をファイルに出力することができます。
また、<tt class="docutils literal"><span class="pre">&amp;&gt;1</span></tt> のようにして標準エラーの出力先を標準出力と同じにすることなどもできます。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; echo &quot;Hello world&quot; &gt; /dev/null
&gt; echo &quot;Hello world&quot; &gt;&gt; /dev/null
&gt; echo &quot;Hello world&quot; 2&gt;&amp;1
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id32">&amp;&amp; || ;</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>Pyshでは他のシェルと同様に <tt class="docutils literal"><span class="pre">;</span></tt> で複数のコマンドを順番に実行したり、
<tt class="docutils literal"><span class="pre">&amp;&amp;</span></tt> で論理積(前者のコマンドが成功したら後者のコマンドを実行)や、
<tt class="docutils literal"><span class="pre">||</span></tt> で論理和(前者のコマンドが失敗したら後者のコマンドを実行)を使うことができます。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; echo foo; echo bar
&gt; echo foo &amp;&amp; echo bar
&gt; echo foo || echo bar
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id33">文字列リテラル</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>Pysh ではシェルコマンド中の文字列リテラルの形式は Python のそれと同じです。
<tt class="docutils literal"><span class="pre">\n</span></tt> などのエスケープ文字もPythonと全く同じ物が利用できます。
Python に慣れていれば、シェル特有の文字列リテラルのルールを覚える必要はありません。
Pythonと同様に3つの <tt class="docutils literal"><span class="pre">&quot;</span></tt> か <tt class="docutils literal"><span class="pre">'</span></tt> で囲まれた範囲はヒアドキュメントとなります。
一方Pyshではその他のシェルと同様に、&quot;で囲まれた文字列中の変数および式($var, ${expr})は 自動的に展開されます。</p>
</div>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id34">バッククオート</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>他のシェルと同じように、`` で囲まれたコマンドのパラメータに指定することで、 コマンドの実行結果を他のコマンドのパラメータとして利用することが可能です。</p>
</div>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id35">バックスラッシュ文字による行継続</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>Python や他のシェルと同じように、行の末尾にバックスラッシュ文字 <tt class="docutils literal"><span class="pre">\</span></tt> をつけると 改行が無視され次の行もつなげて１つの行として評価されます。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; echo foo\
    bar
</pre></div>
</div>
</div>
<div class="section" id="id16">
<h3><a class="toc-backref" href="#id36">コメント</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<p>Python と同様に Pysh では# より後ろの文字はコメントとして扱われます。</p>
<div class="highlight-python"><div class="highlight"><pre>echo &#39;Hello world&#39; # This is a comment
</pre></div>
</div>
</div>
<div class="section" id="map-filter-reduce">
<h3><a class="toc-backref" href="#id37">map filter reduce</a><a class="headerlink" href="#map-filter-reduce" title="Permalink to this headline">¶</a></h3>
<p>ここからは他のシェルにはない pysh 独特の機能を紹介して行きましょう。
Pysh ではPythonのフィルタ系組み込み関数 map, filter, reduce に相当するコマンドが用意されています。</p>
<ul class="simple">
<li>map は標準入力の各行に対して引数で指定された関数を適用し結果を標準出力に出力します。</li>
<li>filter は標準入力の各行に対して引数で指定された関数を適用し、関数が真を返した行のみを出力します。</li>
<li>reduce は標準入力の各行を、引数で指定された関数を使って1つの値に累積的にまとめます。</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre>&gt; seq 10 | map ${lambda s: int(s) * int(s)}
1
4
9
...
&gt; seq 10 | filter ${lambda s: int(s) % 3 == 0}
3
6
9
&gt; seq 10 | reduce ${lambda x, y: int(x) + int(y)}
55
</pre></div>
</div>
<p>map, filter, reduce をPythonの関数と組み合わせて利用することで
grep, sed, awk などを使わなくてもフィルタリング・置換・変形を柔軟に実装できます。
Python にある程度慣れていればいちいち sed や awk の使い方を思い出すよりも効率的に 置換/変形処理が実装できます。</p>
<div class="highlight-python"><div class="highlight"><pre># The lambda expr of reduce does not need to str() to convert input.
&gt; seq 10 | map ${lambda s: int(s) * 2} | reduce ${lambda x, y: x + y}
110
</pre></div>
</div>
</div>
<div class="section" id="id17">
<h3><a class="toc-backref" href="#id38">リターンコードの保存</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>pysh ではコマンドに <tt class="docutils literal"><span class="pre">-&gt;</span></tt> をつけるとそのコマンドのリターンコードが <tt class="docutils literal"><span class="pre">-&gt;</span></tt> の後ろに指定された変数に保存されます。
他のシェルではリターンコードは <tt class="docutils literal"><span class="pre">$?</span></tt> に保存されてしまうため、 パイプされているコマンドのそれぞれのリターンコードを参照することは困難ですが、
pysh ではパイプされているコマンドそれぞれに <tt class="docutils literal"><span class="pre">-&gt;</span></tt> をつけることができるので、
簡単にそれぞれのコマンドのリターンコードを参照できます。
<tt class="docutils literal"><span class="pre">&amp;&amp;</span></tt> や <tt class="docutils literal"><span class="pre">||</span></tt> と共に利用され、<tt class="docutils literal"><span class="pre">-&gt;</span></tt> が指定されたコマンドの実行が行われなかった場合には、Noneが保存されます。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; (python -c &#39;import sys;sys.exit(2)&#39; -&gt; rc0\
    || python -c &#39;import sys;sys;exit(0)&#39; -&gt; rc1)
&gt; print rc0, rc1  # 512 0
</pre></div>
</div>
</div>
<div class="section" id="id18">
<h3><a class="toc-backref" href="#id39">Pythonへのリダイレクション</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<p>pysh ではコマンドの出力をファイルだけではなく Python の変数に対してリダイレクトすることが可能です。
Python 変数に対してリダイレクトするには <tt class="docutils literal"><span class="pre">=&gt;</span></tt> を使います。
コマンドの出力が各行が各要素として格納されたリストに変換され、Pythonの変数として保存されます。
<tt class="docutils literal"><span class="pre">-&gt;</span></tt> と同様にコマンドが実行されなかった場合には <tt class="docutils literal"><span class="pre">None</span></tt> が保存されます。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; seq 5 | grep -v 3 =&gt; out
print out  # [&#39;1&#39;, &#39;2&#39;, &#39;4&#39;, &#39;5&#39;]
&gt; send ${xrange(5)} | filter ${lambda i: i != 3} =&gt; out
print out  # [0, 1, 2, 4]
</pre></div>
</div>
</div>
<div class="section" id="echo">
<h3><a class="toc-backref" href="#id40">echo</a><a class="headerlink" href="#echo" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">=&gt;</span></tt> とは逆に Pytnon 上のデータをシェルコマンドで利用するには <tt class="docutils literal"><span class="pre">echo</span></tt> コマンドを利用します。
pysh の <tt class="docutils literal"><span class="pre">echo</span></tt> コマンドはその他のシェルと同様に引数をスペースで区切った文字列を出力しますが、
引数にリストやタプルなどの文字列以外の iterable なオブジェクトが渡された場合には、リスト・タプルの各要素を一行づつ分けて出力します。</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; echo foo bar  # foo bar
data = [&#39;foo&#39;, &#39;bar&#39;]
&gt; echo $data  # foo
              # bar
&gt; echo $data | sort # bar
                    # foo
</pre></div>
</div>
</div>
<div class="section" id="id19">
<h3><a class="toc-backref" href="#id41">組み込みコマンド をPythonで実装する</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<p>(to be continued....)</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="index.html">yunabe 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
<div class="footer">
    &copy; Copyright 2014, Yu Watanabe.
  Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
<script>
  if(location.host=='www.yunabe.jp'){
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19477574-2', 'yunabe.jp');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
  }
</script>
</div>
  </body>
</html>