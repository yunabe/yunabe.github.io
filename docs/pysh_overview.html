<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Pysh シェルスクリプトをPythonで書く</title>
  <meta name="description" content="">
  <meta property="fb:admins" content="yunabe">
  <meta property="fb:app_id" content="234187763701556">
  <meta property="og:url" href="http://www.yunabe.jp/docs/pysh_overview.html">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.yunabe.jp/docs/pysh_overview.html">
  <link rel="alternate" type="application/rss+xml" title="" href="http://www.yunabe.jp/feed.xml">
  <script>
    if(location.host=='www.yunabe.jp'){
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-19477574-2', 'yunabe.jp');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
    }
  </script>
</head>


  <body>
    <div class="page-content">
      <div class="wrapper">
        <header class="post-header">
          <h1 class="post-title" itemprop="name headline">Pysh シェルスクリプトをPythonで書く</h1>
          <p class="post-meta"><time datetime="2014-07-25T00:00:00+09:00" itemprop="datePublished">更新 Jul 25, 2014</time></p>
        </header>
        <div>
  <div style="display:inline-block;width:69px;vertical-align:top;height:61px;margin-bottom:15px">
    <div class="fb-like" data-layout="box_count" data-action="like" data-show-faces="false" data-share="false"></div>
  </div>
  <div style="display:inline-block;width:56px;vertical-align:top;height:61px;margin-bottom:15px">
    <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical"></a>
  </div>
  <div style="display:inline-block;width:50px;vertical-align:top;height:61px;margin-bottom:15px">
    <div class="g-plusone" data-size="tall"></div>
  </div>
  <div style="display:inline-block;width:80px;vertical-align:top;height:61px;margin-bottom:15px">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
</div>

        <p>Pysh はシェルスクリプトをPythonで記述するためのプログラムです。 Pysh
を利用すると、コマンドの実行やリダイレクションやパイプといったシェルスクリプトの
便利な機能を Python スクリプトの中で簡単に利用できるようになり、 Python
をシェルスクリプトの代わりとしてより利用しやすくなります。 Python
使いならばもはやシェルスクリプトを書く理由は何もありません(Windows以外)。</p>

<ul id="markdown-toc">
  <li><a href="#特徴" id="markdown-toc-特徴">特徴</a></li>
  <li><a href="#使い方" id="markdown-toc-使い方">使い方</a>    <ul>
      <li><a href="#インストール" id="markdown-toc-インストール">インストール</a></li>
      <li><a href="#ファイルから実行" id="markdown-toc-ファイルから実行">ファイルから実行</a></li>
      <li><a href="#標準入力から実行" id="markdown-toc-標準入力から実行">標準入力から実行</a></li>
      <li><a href="#引数から実行" id="markdown-toc-引数から実行">引数から実行</a></li>
    </ul>
  </li>
  <li><a href="#機能" id="markdown-toc-機能">機能</a>    <ul>
      <li><a href="#変数参照" id="markdown-toc-変数参照">変数参照</a></li>
      <li><a href="#python式" id="markdown-toc-python式">Python式</a></li>
      <li><a href="#パイプ" id="markdown-toc-パイプ">パイプ</a></li>
      <li><a href="#リダイレクション" id="markdown-toc-リダイレクション">リダイレクション</a></li>
      <li><a href="#--" id="markdown-toc---">&amp;&amp; || ;</a></li>
      <li><a href="#文字列リテラル" id="markdown-toc-文字列リテラル">文字列リテラル</a></li>
      <li><a href="#バッククオート" id="markdown-toc-バッククオート">バッククオート</a></li>
      <li><a href="#コメント" id="markdown-toc-コメント">コメント</a></li>
      <li><a href="#map-filter-reduce" id="markdown-toc-map-filter-reduce">map filter reduce</a></li>
      <li><a href="#リターンコードの保存" id="markdown-toc-リターンコードの保存">リターンコードの保存</a></li>
      <li><a href="#pythonへのリダイレクション" id="markdown-toc-pythonへのリダイレクション">Pythonへのリダイレクション</a></li>
      <li><a href="#echo" id="markdown-toc-echo">echo</a></li>
      <li><a href="#組み込みコマンド-をpythonで実装する" id="markdown-toc-組み込みコマンド-をpythonで実装する">組み込みコマンド をPythonで実装する</a></li>
    </ul>
  </li>
</ul>

<h1 id="特徴">特徴</h1>

<p>Pysh では Python スクリプトの中に含まれている <code class="highlighter-rouge">&gt;</code>
で始まる行をシェルコマンドとして実行します。 それ以外の部分は通常の
Python スクリプトとして処理されます。 例えば次のスクリプトはfrom00.txt,
from01.txt, …, from99.txt を to00.txt…to99.txt に移動します。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in xrange(100):
  index = "%02d" % i
  &gt; mv from$index.txt to$index.txt
</code></pre></div></div>

<p>Pysh は次のような特徴を持ちます</p>

<ul>
  <li><code class="highlighter-rouge">&gt;</code> で始まる行をシェルコマンドとして実行できる。</li>
  <li>シェルコマンドの中から <strong>Pythonの変数</strong>
がシェルスクリプトと同じように <code class="highlighter-rouge">$var</code> のように参照できる。</li>
  <li>パイプやリダイレクションも利用可能</li>
  <li>if,
for文などはシェルコマンドの中では利用できない。プログラムの制御はPythonで行う。</li>
  <li>フィルタ系組み込み関数 map, filter, reduce
がコマンドとして利用できる。 grep, sed, awk
を利用しなくても柔軟なフィルタリング・置換・変形が行える。</li>
  <li>組み込みコマンドを Python で書くことができる。</li>
  <li>Pythonで書かれたコマンドは入出力をPythonオブジェクトとして扱うことができる。</li>
  <li>またPythonオブジェクトのまま、出力を他のコマンドにパイプすることができる</li>
</ul>

<h1 id="使い方">使い方</h1>

<h2 id="インストール">インストール</h2>

<p><a href="https://github.com/yunabe/pysh">GitHubからソースコード</a>
をチェックアウトします。 Pysh は Python で実装されているので Python
がインストールされている環境ならば
簡単に実行できます。ただしWindowsはサポート外です。 pysh
はスクリプトファイルをファイル・標準入力・引数のいずれかで与えて実行することができます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout https://github.com/yunabe/pysh.git
./pysh/bin/pysh&lt;/pre&gt;
</code></pre></div></div>

<h2 id="ファイルから実行">ファイルから実行</h2>

<p>python
コマンドと同様に、pyshの引数としてファイルを与えるとファイルをpyshスクリプトとして
解釈し実行します。 pysh コマンドは与えられたファイルを通常の Python
スクリプトに変換し Python として実行を行います。
そのため実行後、スクリプト名と同名の拡張子が .py のファイルが残ります。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pysh script.pysh
</code></pre></div></div>

<h2 id="標準入力から実行">標準入力から実行</h2>

<p>python コマンドと同様に、pyshの引数として <code class="highlighter-rouge">-</code> を与えると
標準入力からpyshスクリプトを読み込み実行します。
この機能はpyshをワンライナーの代わりに利用する際に重宝します。
複雑で読みづらいワンライナーを書くぐらいなら Python
で構造化されたプログラムを書きましょう。
構造化されたスクリプトはワンライナーよりも遥かに読みやすく、将来再利用することができます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pysh - &lt;&lt; 'EOF'
for i in xrange(3):
  index = "%02d" % i
  &gt; echo $index
EOF
</code></pre></div></div>

<h2 id="引数から実行">引数から実行</h2>

<p>python コマンドと同様に、pyshの引数として <code class="highlighter-rouge">-c cmd</code> を与えると <code class="highlighter-rouge">cmd</code>
をスクリプトとして解釈、実行します。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pysh -c "`cat &lt;&lt; 'EOF'
for i in xrange(3):
  index = "%02d" % i
  &gt; echo $index
EOF`"&lt;/pre&gt;
</code></pre></div></div>

<h1 id="機能">機能</h1>

<h2 id="変数参照">変数参照</h2>

<p><code class="highlighter-rouge">$var</code> でPythonの変数をシェルコマンドの中から参照することができます。
環境変数も <code class="highlighter-rouge">$PATH</code> のように Python の変数と同じように参照できます。
また他のシェルと同様に <code class="highlighter-rouge">""</code>
で囲まれた文字列中の変数は自動的に展開されます。 <code class="highlighter-rouge">''</code>
で囲まれた文字列中の変数は展開されません。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x = 3
y = x * x
&gt; echo $y     # 9
&gt; echo $PATH  # os.environment['PATH']
&gt; echo "$x * $x = $y"  # 3 * 3 = 9
&gt; echo '$x * $x = $y'  # $x * $x = $y
</code></pre></div></div>

<h2 id="python式">Python式</h2>

<p>Pyshでは変数だけでなく任意の Python
式をシェルコマンドの中で利用することができます。
シェルコマンドの中でPython式を書くには&lt;code&gt;${expr}&lt;/code&gt;のように書きます。
変数参照と同様に、 <code class="highlighter-rouge">""</code> 文字列中のPython式は評価されますが <code class="highlighter-rouge">''</code>
文字列中のPython式は評価されません。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; echo ${3 + 4}  # 7
def f(x):
  return x * x
&gt; echo ${f(10)}  # 100
&gt; echo ${lambda x: x}
</code></pre></div></div>

<h2 id="パイプ">パイプ</h2>

<p>Pysh ではその他のシェルと同じようにコマンドの入出力をパイプ <code class="highlighter-rouge">|</code>
でつなぐことができます</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; echo "foo\nbar" | tac
</code></pre></div></div>

<h2 id="リダイレクション">リダイレクション</h2>

<p>Pysh
ではリダイレクションを使ってコマンドの出力結果をファイルに出力することができます。
また、<code class="highlighter-rouge">&amp;&gt;1</code>
のようにして標準エラーの出力先を標準出力と同じにすることなどもできます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; echo "Hello world" &gt; /dev/null
&gt; echo "Hello world" &gt;&gt; /dev/null
&gt; echo "Hello world" 2&gt;&amp;1
</code></pre></div></div>

<h2 id="--">&amp;&amp; || ;</h2>

<p>Pyshでは他のシェルと同様に <code class="highlighter-rouge">;</code> で複数のコマンドを順番に実行したり、 <code class="highlighter-rouge">&amp;&amp;</code>
で論理積(前者のコマンドが成功したら後者のコマンドを実行)や、 <code class="highlighter-rouge">||</code>
で論理和(前者のコマンドが失敗したら後者のコマンドを実行)を使うことができます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; echo foo; echo bar
&gt; echo foo &amp;&amp; echo bar
&gt; echo foo || echo bar
</code></pre></div></div>

<h2 id="文字列リテラル">文字列リテラル</h2>

<p>Pysh ではシェルコマンド中の文字列リテラルの形式は Python
のそれと同じです。 <code class="highlighter-rouge">\n</code>
などのエスケープ文字もPythonと全く同じ物が利用できます。 Python
に慣れていれば、シェル特有の文字列リテラルのルールを覚える必要はありません。
Pythonと同様に3つの <code class="highlighter-rouge">"</code> か <code class="highlighter-rouge">'</code>
で囲まれた範囲はヒアドキュメントとなります。
一方Pyshではその他のシェルと同様に、”で囲まれた文字列中の変数および式($var,
${expr})は 自動的に展開されます。</p>

<h2 id="バッククオート">バッククオート</h2>

<p>他のシェルと同じように、`` で囲まれたコマンドのパラメータに指定することで、 コマンドの実行結果を他のコマンドのパラメータとして利用することが可能です。</p>

<p>##バックスラッシュ文字による行継続</p>

<p>Python や他のシェルと同じように、行の末尾にバックスラッシュ文字<code class="highlighter-rouge">\</code>
をつけると 改行が無視され次の行もつなげて１つの行として評価されます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; echo foo\
    bar
</code></pre></div></div>

<h2 id="コメント">コメント</h2>

<p>Python と同様に Pysh では# より後ろの文字はコメントとして扱われます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 'Hello world' # This is a comment
</code></pre></div></div>

<h2 id="map-filter-reduce">map filter reduce</h2>

<p>ここからは他のシェルにはない pysh 独特の機能を紹介して行きましょう。
Pysh ではPythonのフィルタ系組み込み関数 map, filter, reduce
に相当するコマンドが用意されています。</p>

<ul>
  <li>map
は標準入力の各行に対して引数で指定された関数を適用し結果を標準出力に出力します。</li>
  <li>filter
は標準入力の各行に対して引数で指定された関数を適用し、関数が真を返した行のみを出力します。</li>
  <li>reduce
は標準入力の各行を、引数で指定された関数を使って1つの値に累積的にまとめます。</li>
</ul>

<!-- -->

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; seq 10 | map ${lambda s: int(s) * int(s)}
1
4
9
...
&gt; seq 10 | filter ${lambda s: int(s) % 3 == 0}
3
6
9
&gt; seq 10 | reduce ${lambda x, y: int(x) + int(y)}
55
</code></pre></div></div>

<p>map, filter, reduce をPythonの関数と組み合わせて利用することで grep,
sed, awk
などを使わなくてもフィルタリング・置換・変形を柔軟に実装できます。
Python にある程度慣れていればいちいち sed や awk
の使い方を思い出すよりも効率的に 置換/変形処理が実装できます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># The lambda expr of reduce does not need to str() to convert input.
&gt; seq 10 | map ${lambda s: int(s) * 2} | reduce ${lambda x, y: x + y}
110
</code></pre></div></div>

<h2 id="リターンコードの保存">リターンコードの保存</h2>

<p>pysh ではコマンドに <code class="highlighter-rouge">-&gt;</code> をつけるとそのコマンドのリターンコードが <code class="highlighter-rouge">-&gt;</code>
の後ろに指定された変数に保存されます。 他のシェルではリターンコードは
<code class="highlighter-rouge">$?</code> に保存されてしまうため、
パイプされているコマンドのそれぞれのリターンコードを参照することは困難ですが、
pysh ではパイプされているコマンドそれぞれに <code class="highlighter-rouge">-&gt;</code>
をつけることができるので、
簡単にそれぞれのコマンドのリターンコードを参照できます。 <code class="highlighter-rouge">&amp;&amp;</code> や <code class="highlighter-rouge">||</code>
と共に利用され、<code class="highlighter-rouge">-&gt;</code>
が指定されたコマンドの実行が行われなかった場合には、Noneが保存されます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; (python -c 'import sys;sys.exit(2)' -&gt; rc0\
    || python -c 'import sys;sys;exit(0)' -&gt; rc1)
&gt; print rc0, rc1  # 512 0
</code></pre></div></div>

<h2 id="pythonへのリダイレクション">Pythonへのリダイレクション</h2>

<p>pysh ではコマンドの出力をファイルだけではなく Python
の変数に対してリダイレクトすることが可能です。 Python
変数に対してリダイレクトするには <code class="highlighter-rouge">=&gt;</code> を使います。
コマンドの出力が各行が各要素として格納されたリストに変換され、Pythonの変数として保存されます。
<code class="highlighter-rouge">-&gt;</code> と同様にコマンドが実行されなかった場合には <code class="highlighter-rouge">None</code> が保存されます。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; seq 5 | grep -v 3 =&gt; out
print out  # ['1', '2', '4', '5']
&gt; send ${xrange(5)} | filter ${lambda i: i != 3} =&gt; out
print out  # [0, 1, 2, 4]
</code></pre></div></div>

<h2 id="echo">echo</h2>

<p><code class="highlighter-rouge">=&gt;</code> とは逆に Pytnon 上のデータをシェルコマンドで利用するには <code class="highlighter-rouge">echo</code>
コマンドを利用します。 pysh の <code class="highlighter-rouge">echo</code>
コマンドはその他のシェルと同様に引数をスペースで区切った文字列を出力しますが、
引数にリストやタプルなどの文字列以外の iterable
なオブジェクトが渡された場合には、リスト・タプルの各要素を一行づつ分けて出力します。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; echo foo bar  # foo bar
data = ['foo', 'bar']
&gt; echo $data  # foo
              # bar
&gt; echo $data | sort # bar
                    # foo
</code></pre></div></div>

<h2 id="組み込みコマンド-をpythonで実装する">組み込みコマンド をPythonで実装する</h2>

<p>(to be continued….)</p>

        <div>
  <div style="display:inline-block;width:69px;vertical-align:top;height:61px;margin-bottom:15px">
    <div class="fb-like" data-layout="box_count" data-action="like" data-show-faces="false" data-share="false"></div>
  </div>
  <div style="display:inline-block;width:56px;vertical-align:top;height:61px;margin-bottom:15px">
    <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical"></a>
  </div>
  <div style="display:inline-block;width:50px;vertical-align:top;height:61px;margin-bottom:15px">
    <div class="g-plusone" data-size="tall"></div>
  </div>
  <div style="display:inline-block;width:80px;vertical-align:top;height:61px;margin-bottom:15px">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
</div>

        <div class="fb-comments" data-href="http://www.yunabe.jp/docs/pysh_overview.html"  data-numposts="5"></div>
        <div style="text-align:center">
          <a href="/docs">Home</a>
        </div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li></li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>

    <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.8&appId=234187763701556";
  fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<script src="https://apis.google.com/js/platform.js" async defer>
  {lang: 'ja'}
</script>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

    
  </body>

</html>
