<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Cookie の仕様とセキュリティ</title>
  <meta name="description" content="">
  <meta property="fb:admins" content="yunabe">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.yunabe.jp/docs/cookie_and_security.html">
  <link rel="alternate" type="application/rss+xml" title="" href="http://www.yunabe.jp/feed.xml">
  <script>
    if(location.host=='www.yunabe.jp'){
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-19477574-2', 'yunabe.jp');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
    }
  </script>
</head>


  <body>
    <div class="page-content">
      <div class="wrapper">
        <header class="post-header">
          <h1 class="post-title" itemprop="name headline">Cookie の仕様とセキュリティ</h1>
          <p class="post-meta"><time datetime="2015-04-22T00:00:00+09:00" itemprop="datePublished">更新 Apr 22, 2015</time></p>
        </header>
        <div>
  <div style="display:inline-block;width:69px;vertical-align:top;height:61px;margin-bottom:15px">
    <div class="fb-like" data-layout="box_count" data-action="like" data-show-faces="false" data-share="false"></div>
  </div>
  <div style="display:inline-block;width:56px;vertical-align:top;height:61px;margin-bottom:15px">
    <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical"></a>
  </div>
  <div style="display:inline-block;width:50px;vertical-align:top;height:61px;margin-bottom:15px">
    <div class="g-plusone" data-size="tall"></div>
  </div>
  <div style="display:inline-block;width:80px;vertical-align:top;height:61px;margin-bottom:15px">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
</div>

        <ul id="markdown-toc">
  <li><a href="#set-cookie--cookie-">Set-Cookie ヘッダを使って Cookie を保存する</a></li>
  <li><a href="#cookie-">Cookie を参照する</a></li>
  <li><a href="#javascript--cookie-">JavaScript を使って Cookie を保存・参照する</a></li>
  <li><a href="#cookie--1">Cookie の属性</a>    <ul>
      <li><a href="#domain">domain属性</a></li>
      <li><a href="#path">path属性</a></li>
      <li><a href="#max-age--expire">max-age と expire</a></li>
      <li><a href="#secure">secure</a></li>
      <li><a href="#httponly">httponly</a></li>
    </ul>
  </li>
  <li><a href="#section">その他</a>    <ul>
      <li><a href="#port">クッキーとport番号</a></li>
    </ul>
  </li>
</ul>

<p>このドキュメントの目的は Cookie
とは何かを一から説明することではないので、そもそもCookieとは何で何に使えるのかといった話は、
<a href="http://ja.wikipedia.org/wiki/HTTP_cookie">Wikipedia の Cookie の記事</a>
などを参考にして下さい。 ここでは Cookie
がどういうものかは大体理解しているという前提で、仕様の確認をしていきます。</p>

<h1 id="set-cookie--cookie-">Set-Cookie ヘッダを使って Cookie を保存する</h1>

<p>Cookie を設定する一番基本的な方法は HTTPヘッダ の Set-Cookie
を使う方法です。</p>

<pre><code>Set-Cookie: name=value
</code></pre>

<p>のような HTTP header をサーバから返すと name と value
のペアがブラウザに保存されて、後からそれを参照することができます。
Set-Cookie
に属性をつけて保存期間やCookieが送信される条件などを制御することも可能です。
属性をつけるには、 <code>" ;max-age=3600"</code> や <code>" ;Secure"</code> のように <code>" ;"</code> +
属性名 + <code>"="</code> + 属性の値を後ろに追加します。 (厳密には <code>;</code>
の後ろには半角スペースが必要で末尾には <code>;</code> は付けません。
多くのブラウザは半角スペースを削除したり末尾に不要な <code>;</code>
をつけても問題なく動くでしょうが)</p>

<pre><code>Set-Cookie: name=value; max-age=3600; Secure
</code></pre>

<p>これは、name=value
というクッキーを3600秒間保存しておきなさい、ただしそのクッキーが利用できるのはhttps
のページでのみです、 と指定してることになります。</p>

<p>複数の name-value のペアを設定したい場合は Set-Cookie
ヘッダを複数送ります。</p>

<pre><code>Set-Cookie: name0=value0
Set-Cookie: name1=value1
</code></pre>

<h1 id="cookie-">Cookie を参照する</h1>

<p><code>Set-Cookie</code> で保存された Cookie は、HTTP Request の Cookie
ヘッダとしてブラウザからサーバーに送信されます。 Cookie ヘッダは</p>

<pre><code>Cookie: name=0=value0; name1=value1
</code></pre>

<p>のように、ブラウザに保存されているクッキーの name=value のペアを <code>"; "</code>
で連結したものものになります。
どのクッキーがサーバーに対して送信されるかは、Set-Cookie で指定した
max-age や Secure などの属性によって制御することができます。 Secure
が指定されていれば、サーバーが https の時にしか送信されないし、 max-age
を超えた古くなったクッキーも送信されません(ブラウザから削除されます)。</p>

<p>クッキーの順序は以下のように決まります。</p>

<ul>
  <li>後述する path 属性のなるべく長いものが前に来る</li>
  <li>path 属性の長さが同じ場合は、最近作られたものが前に来る</li>
</ul>

<p>また後述するように、クッキーはnameが同一でも <code>domain</code>, <code>path</code>
属性の値が異なれば別のものとして扱われるので、 <strong>同じ name
のクッキーが複数 Cookieヘッダの中に現れることがありうる</strong>
ので注意してください。 例えば、www.example.com にあるサーバーが</p>

<pre><code>Set-Cookie: myname=value0; example.com; path=/
Set-Cookie: myname=value1; www.example.com; path=/
</code></pre>

<p>という Set-Cookie でクッキーを設定した場合、ブラウザは</p>

<pre><code>Set-Cookie: myname=value1; myname=value0
</code></pre>

<p>のように同じ名前のCookieを２つサーバーに送るようになります。</p>

<h1 id="javascript--cookie-">JavaScript を使って Cookie を保存・参照する</h1>

<p>document.cookie というプロパティを利用して JavaScript から cookie
を設定したり参照することができます。</p>

<pre><code>document.cookie = "name=value";
</code></pre>

<p>のように document.cookie に対して文字列を代入すると、
<code>Set-Cookkie: name=value</code>
ヘッダをサーバーからブラウザに送信した場合と同じことが起こります。
Set-Cookie ヘッダとどうように、属性を付けることができます。</p>

<pre><code>document.cookie = "name=value; max-age=3600; Secure"
</code></pre>

<p>復数のクッキーを指定した場合は、Set-Cookieヘッダと似たような感じに1つずつ代入します。</p>

<pre><code>document.cookie = "name0=value0";
document.cookie = "name1=value1";
</code></pre>

<p>クッキーの値を参照するには、 <code>document.cookie</code> プロパティを参照します。
<code>document.cookie</code> プロパティは参照すると <code>Cookie</code>
ヘッダで送信されるのと同じ文字列を得ることができます。</p>

<pre><code>console.log(document.cookie);  // “name=0=value0; name1=value1”
</code></pre>

<p><code>document.cookie</code> は一見すると string
型のプロパティのように見えますが、そうではないことに注意して下さい。
<code>document.cookie</code> へ代入した文字列と <code>document.cookie</code>
を読んだ時に得られる文字列はまったく異なります。 また、<code>document.cookie</code>
に空文字を代入しても 空の <code>Set-Cookie</code>
を送ったのと同じことにしかならないので何も起こりません。
クッキーは削除されず、<code>document.cookie</code>
を読んだ時に得られる値も変化しません。</p>

<h1 id="cookie--1">Cookie の属性</h1>

<h2 id="domain">domain属性</h2>

<p>Set-Cookieでクッキーをブラウザに保存する際、domain
という属性を付加することでクッキーが送信される
(あるいはdocument.cookieでクッキーが読み取れる)ドメインを制御することができます。</p>

<pre><code>Set-Cookie: name=value; domain=example.com
</code></pre>

<p>domain属性が指定されている場合、そのクッキーは domain で指定された
domain 自体とそのサブドメインに対して送信されます。
上の例の場合、このクッキーは example.com, www.example.com,
docs.example.com などのホストに対して送信されます。 一方で domain
を指定しない場合は、Set-Cookie
を送信したホストにのみクッキーは送信されます。 domain
属性なしで、example.com によって設定されたクッキーは www.example.com や
docs.example.com には送信されません。 domain
を省略した場合と、domainに今接続しているホスト名を指定した場合ではクッキーが送信される範囲が異なる点に注意が必要です。
サブドメインに送信されてはならないクッキーには domain
属性はつけてはなりません。</p>

<p>また
domain属性で指定するドメインは現在のホスト名を含むドメインでなくてはなりません。
そうでない値を指定した場合は無視されます。例えばあるページが
www.example.com にある場合、domain に example.com を指定してクッキーが
example.com 以下のあらゆるホストに対して送信されるように設定できますが、
domain に google.com を指定して google.com
に対してクッキーを送信するように設定することはできません。また、domain属性に
abc.www.example.com を指定してサブドメイン abc.www.example.com
にのみクッキーが送信されるようにすることもできません。</p>

<p>domain 属性の値の先頭に “.” を付けても構いません。その “.”
は無視されます。 また念の為述べておくと domain に www.example あるいは
www.example. などと指定しても www.example.co.jp と example.com
にクッキーを送信されたりはしません。</p>

<h2 id="path">path属性</h2>

<p>クッキーには path 属性を指定することができます。</p>

<pre><code>Set-Cookie: name=value; path=/mydir
</code></pre>

<p>のように path属性を指定するとクッキーは /mydir/ に含まれるURL (e.g.
<a href="http://example.com/mydir/">http://example.com/mydir/</a>, <a href="http://example.com/mydir/index.html">http://example.com/mydir/index.html</a>,
<a href="http://example.com/mydir/subdir/">http://example.com/mydir/subdir/</a>) にのみ送信されます。path
が省略された場合は現在のURL の path が使われます。例えば現在のページが
<a href="http://example.com/mydir/subdir/index.html">http://example.com/mydir/subdir/index.html</a> であれば /mydir/subdir/ が
path
に設定されます。ほとんどの場合、同一ドメインの全てのリクエストでクッキーが送信されるようにしたいと思うので、多くの場合
path=/ を常に指定することになります。path=/
を指定するのをうっかり忘れると、http://example.com/2014/11/
で指定されたクッキーが <a href="http://example.com/2013/12/">http://example.com/2013/12/</a>
には送信されません。</p>

<p>さて、path も domain
と同じようにクッキーが送信される範囲を制御するので、セキュリティ上重要なように一見すると思えますが、実は
pathはセキュリティ保護には利用できません。<a href="http://www.ipa.go.jp/security/awareness/vendor/programmingv2/contents/304.html">IPAの第4章
セッション対策</a>
には path をなるべく限定しておいたほうがよいような記述がありますが、path
を限定してもその他の path
にあるリソースからクッキーを読む方法は存在するので気をつけて下さい。セッションIDなどを保存するのであれば、普通は
<code>path=/</code> を指定すると思います。</p>

<h2 id="max-age--expire">max-age と expire</h2>

<p>max-age あるいは expire 属性でクッキーの寿命が指定できます。</p>

<pre><code>Set-Cookie: name=value; max-age=3600
Set-Cookie: name=value; expires=Tue, 19 Jan 2038 03:14:07 GMT
</code></pre>

<ul>
  <li><code>max-age</code>
ではクッキーの寿命を秒数で指定します。負の値を指定すると、最も過去の日付を指定したことになります。</li>
  <li><code>expires</code> では有効期限が切れる日付・時刻を指定します。</li>
  <li><code>max-age</code> と <code>expires</code> の両方が指定された場合は <code>max-age</code>
が使用されます。</li>
  <li><code>max-age</code> はかなり古いブラウザではサポートされない場合があります。</li>
  <li><code>max-age</code>, <code>expires</code>
がなく寿命が指定されていない場合は、クッキーはブラウザが閉じられると削除されます。</li>
</ul>

<h2 id="secure">secure</h2>

<p>うっかり忘れられがちですが、セキュリティ上とても大切な仕様です。 Secure
属性をつけた場合、そのクッキーは接続が https
で保護されている場合のみに送信されます。
Secure属性には値は必要ありません。</p>

<p>デフォルトではクッキーは接続が <code>https</code> なのか <code>http</code>
なのかには関係なく動作します。 https 接続で設定されたクッキーであっても
Secure 属性がなければ同じホスト名に http
で接続した場合にもそのクッキーは送信されてしまい、通信経路上にいる第三者に盗聴される可能性があります。
セッションID のような第三者に盗み見られてはならないクッキーは必ず Secure
属性をつけなくてはなりません。 絶対に忘れないようにしましょう。</p>

<h2 id="httponly">httponly</h2>

<p>httponly 属性をつけると、そのクッキーは <code>Cookie</code>
ヘッダ以外から読み取ることができなくなりなり、JavaScript
から参照できなくなります。 Secureの反対の意味、 http
でしか送信されないCookieという意味では <strong>ない</strong> ので気をつけて下さい。</p>

<p>このオプションはXSS脆弱性があった場合の被害を小さくします。
XSS脆弱性によって攻撃者が任意のJavaScriptが実行できてしまうと、
<code>document.cookie</code> の値を読んで Session ID
などのログイン情報などを盗み見れてしまう可能性がありますが、
HttpOnly属性をつけておくとクッキーが XSS
脆弱性によって読み取られることがなくなります。 Session ID などのように
JavaScript から読み取る必要がないクッキーには HttpOnly
を忘れずに付けておいたほうが良いでしょう。</p>

<h1 id="section">その他</h1>

<h2 id="port">クッキーとport番号</h2>

        <div>
  <div style="display:inline-block;width:69px;vertical-align:top;height:61px;margin-bottom:15px">
    <div class="fb-like" data-layout="box_count" data-action="like" data-show-faces="false" data-share="false"></div>
  </div>
  <div style="display:inline-block;width:56px;vertical-align:top;height:61px;margin-bottom:15px">
    <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical"></a>
  </div>
  <div style="display:inline-block;width:50px;vertical-align:top;height:61px;margin-bottom:15px">
    <div class="g-plusone" data-size="tall"></div>
  </div>
  <div style="display:inline-block;width:80px;vertical-align:top;height:61px;margin-bottom:15px">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
</div>

        <div class="fb-comments" data-href="http://www.yunabe.jp/docs/cookie_and_security.html"  data-numposts="5"></div>
        <div style="text-align:center">
          <a href="/docs">Home</a>
        </div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li></li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>

    <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  console.log(fjs);
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<script src="https://apis.google.com/js/platform.js" async defer>
  {lang: 'ja'}
</script>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>


  </body>

</html>
