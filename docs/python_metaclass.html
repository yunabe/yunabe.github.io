
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
<meta content="width=device-width, initial-scale=1" name="viewport" />
<title>Python の メタプログラミング (__metaclass__, メタクラス) を理解する</title>
    
    <link rel="stylesheet" href="_static/main.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="yunabe 0.1 documentation" href="index.html" />
    <link rel="next" title="イベントはスレッドに比べて何故ダメなのか (Why Events Are A Bad Idea)" href="why_events_are_a_bad_idea.html" />
    <link rel="prev" title="Python パッケージ管理技術まとめ (pip, setuptools, easy_install, etc)" href="python_package_management.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="why_events_are_a_bad_idea.html" title="イベントはスレッドに比べて何故ダメなのか (Why Events Are A Bad Idea)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="python_package_management.html" title="Python パッケージ管理技術まとめ (pip, setuptools, easy_install, etc)"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">yunabe 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Python の メタプログラミング (__metaclass__, メタクラス) を理解する</a><ul>
<li><a class="reference internal" href="#id1">事前知識</a><ul>
<li><a class="reference internal" href="#type">type とクラス定義のあまり知られていない関係</a></li>
<li><a class="reference internal" href="#new">特殊メソッド __new__</a></li>
</ul>
</li>
<li><a class="reference internal" href="#metaclass">__metaclass__</a><ul>
<li><a class="reference internal" href="#id7">typeの継承</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="python_package_management.html"
                        title="previous chapter">Python パッケージ管理技術まとめ (pip, setuptools, easy_install, etc)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="why_events_are_a_bad_idea.html"
                        title="next chapter">イベントはスレッドに比べて何故ダメなのか (Why Events Are A Bad Idea)</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/python_metaclass.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="python-metaclass">
<h1>Python の メタプログラミング (__metaclass__, メタクラス) を理解する<a class="headerlink" href="#python-metaclass" title="Permalink to this headline">¶</a></h1>
<p>Pythonのメタプログラミング (__metaclass__) は組み込み関数 <tt class="docutils literal"><span class="pre">type</span></tt> の普段利用しない隠れた機能や、
普通は利用しない特殊メソッド <tt class="docutils literal"><span class="pre">__new__</span></tt> などを理解する必要があり
理解するのが結構難しい。
あまり関連情報がまとまってるドキュメントがなくて理解するのに苦労したので情報をまとめておきました。</p>
<div class="section" id="id1">
<h2>事前知識<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://docs.python.org/2/reference/datamodel.html#customizing-class-creation">Customizing class creation</a>
(<a class="reference external" href="http://docs.python.jp/2/reference/datamodel.html#metaclasses">クラス生成をカスタマイズする</a>)
を読むと、型を取得するのに普通利用するbuiltin関数 <tt class="docutils literal"><span class="pre">type</span></tt> を継承していたり、
普通利用することのない <tt class="docutils literal"><span class="pre">__new__</span></tt> が定義されていたりして、
<tt class="docutils literal"><span class="pre">type</span></tt> の隠された機能と <tt class="docutils literal"><span class="pre">__new__</span></tt> について理解していないと
何が書かれているかさっぱり分からないと思います。
まずは __metaclass__ を理解する上で重要なこの2つについて整理しておきましょう。</p>
<div class="section" id="type">
<h3>type とクラス定義のあまり知られていない関係<a class="headerlink" href="#type" title="Permalink to this headline">¶</a></h3>
<p>ご存知のように Python には type という builtin 関数が定義されています。
type は type(obj) のように1つの引数を与えて obj の型を取得するのに利用したことがあるはずです。
普通はこちらの機能しか使いません。</p>
<p>しかし実は type にはもう一つの隠れた機能があります。
第1引数に文字列でクラス名、第2引数に親クラスの列、第3引数にクラスのメソッドや属性を定義した dict
を渡して type を呼び出すとクラスを動的に定義することが可能です。:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ClassName</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">):</span>
  <span class="n">attrivute1</span> <span class="o">=</span> <span class="n">value1</span>

  <span class="k">def</span> <span class="nf">function1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>のように普段クラスを定義していると思いますが、これは type を使うと:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">function1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
   <span class="o">...</span>

<span class="n">ClassName</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;ClassName&#39;</span><span class="p">,</span>
                 <span class="p">[</span><span class="n">P0</span><span class="p">,</span><span class="n">P1</span><span class="p">,],</span>
                 <span class="p">{</span><span class="s">&#39;attribute1&#39;</span><span class="p">:</span> <span class="n">value1</span><span class="p">,</span>
                  <span class="s">&#39;function1&#39;</span><span class="p">:</span> <span class="n">function1</span><span class="p">,})</span>
</pre></div>
</div>
<p>のように定義することも可能です。この2つの定義は全く同じ実行結果が得られます。
ここで2つ目の type を使った定義をよく見てみると、
実は ClassName は type クラスにクラス名、親クラス、クラス定義を渡してインスタンス生成
したものだということが分かります。クラスは <tt class="docutils literal"><span class="pre">type</span></tt> のインスタンスなのです。
その証拠に <tt class="docutils literal"><span class="pre">type(cls)</span></tt> は <tt class="docutils literal"><span class="pre">type</span></tt> を返しますし、
<tt class="docutils literal"><span class="pre">isinstance(cls,</span> <span class="pre">type)</span></tt> は True を返します。</p>
</div>
<div class="section" id="new">
<h3>特殊メソッド __new__<a class="headerlink" href="#new" title="Permalink to this headline">¶</a></h3>
<p>Python でクラスを定義する際に、インスタンスを初期化するメソッドとして
<tt class="docutils literal"><span class="pre">__init__</span></tt> を使います。
厳密には Python には「コンストラクタ」という用語はありませんが、
C++/Java におけるコンストラクタに相当する処理は普通 <tt class="docutils literal"><span class="pre">__init__</span></tt> に書かれます。
しかし実は Python にはインスタンスの生成方法を定義するもう一つの <a class="reference external" href="https://docs.python.org/2/reference/datamodel.html#object.__new__">特殊メソッド __new__</a>
が存在します (<a class="reference external" href="http://docs.python.jp/2/reference/datamodel.html#object.__new__">__new__ の日本語のドキュメント</a>)。</p>
<p>Python でクラスを定義して、それを呼び出してインスタンスの生成を行うと <tt class="docutils literal"><span class="pre">__init__</span></tt> が
暗黙的に呼び出されインスタンスの初期化が行われると理解していると思いますが、
実はその前に <tt class="docutils literal"><span class="pre">__new__</span></tt> による処理が存在しています。
クラスのインスタンス生成を行った際に暗黙的に行われている処理はより正確に書くと</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">class</span> <span class="pre">ClassName</span></tt> が <tt class="docutils literal"><span class="pre">ClassName()</span></tt> によってインスタンス生成された場合</li>
<li>まず <tt class="docutils literal"><span class="pre">ClassName.__new__</span></tt> が第1引数に ClassName, 残りの引数に
ClassName に与えた残りの引数が与えられて呼び出される。</li>
<li>普通は <tt class="docutils literal"><span class="pre">__new__</span></tt> は定義されていないので親クラスをたどっていって最終的に
<tt class="docutils literal"><span class="pre">object.__new__</span></tt> が呼び出される。<tt class="docutils literal"><span class="pre">object.__new__</span></tt> は第1引数で与えられた
クラスのインスタンスを生成して返す。<tt class="docutils literal"><span class="pre">object.__new__</span></tt> が返すインスタンスは
<tt class="docutils literal"><span class="pre">__init__</span></tt> が実行される前の未初期化のインスタンスである点に注意。</li>
<li>__new__ が ClassName のインスタンスを返した場合に限り <tt class="docutils literal"><span class="pre">ClassName.__init__</span></tt>
が呼び出される。</li>
</ul>
<p>というようになっています。
例えばものすごく極端な例ですが:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;__init__&#39;</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span>
<span class="k">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>のようなコードを書くと、<tt class="docutils literal"><span class="pre">c</span></tt> には <tt class="docutils literal"><span class="pre">'43'</span></tt> が代入されます。
そして <tt class="docutils literal"><span class="pre">__init__</span></tt> は呼び出されません。</p>
<p><tt class="docutils literal"><span class="pre">__new__</span></tt> の役割はかなり理解しづらいと思うので
よくドキュメントを読んでサンプルを書いて動かしていろいろ試してみたほうがよいかと思います。
個人的には ClassNameを呼び出すと <tt class="docutils literal"><span class="pre">__init__</span></tt> が暗黙的に呼び出されるという
先入観が強すぎるせいか、 <tt class="docutils literal"><span class="pre">__new__</span></tt> で何が制御できるのか理解するのがなかなか大変でした。</p>
</div>
</div>
<div class="section" id="metaclass">
<h2>__metaclass__<a class="headerlink" href="#metaclass" title="Permalink to this headline">¶</a></h2>
<p>class を定義すると自動的に type('ClassName', ...) が呼び出されて
クラスが生成されるということを type の節で述べました。
実は Python ではこの class を定義される際に暗黙的に呼び出される関数を
別の関数で置き換えることができます。
これが <a class="reference external" href="https://docs.python.org/2.7/reference/datamodel.html#__metaclass__">__metaclass__</a> です
(<a class="reference external" href="http://docs.python.jp/2/reference/datamodel.html#__metaclass__">__metaclass__ の日本語のドキュメント</a>)。</p>
<p>classの定義に <tt class="docutils literal"><span class="pre">__metaclass__</span></tt> が存在すると
クラスを生成する際に <tt class="docutils literal"><span class="pre">__metaclass__</span></tt> に格納された関数が <tt class="docutils literal"><span class="pre">type</span></tt> の代わりに呼び出されます。
metaclass という名前がついていますが、__metaclass__ は class である必要はありません。
<tt class="docutils literal"><span class="pre">type</span></tt> と同様の引数を受け取れるcallableなオブジェクトならば何でも __metaclass__ として利用できます。
例えば:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tolower_classname</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ClassName</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">tolower_classname</span>

<span class="k">print</span> <span class="n">ClassName</span><span class="o">.</span><span class="n">__name__</span>  <span class="c"># classname</span>
</pre></div>
</div>
<p>のようなコードを書くと、ClassName の名前が 'classname' になります
(classname というクラスが ClassName という変数に格納されている状態)。</p>
<div class="section" id="id7">
<h3>typeの継承<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>(to be continued...)</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="why_events_are_a_bad_idea.html" title="イベントはスレッドに比べて何故ダメなのか (Why Events Are A Bad Idea)"
             >next</a> |</li>
        <li class="right" >
          <a href="python_package_management.html" title="Python パッケージ管理技術まとめ (pip, setuptools, easy_install, etc)"
             >previous</a> |</li>
        <li><a href="index.html">yunabe 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
<div class="footer">
    &copy; Copyright 2014, Yu Watanabe.
  Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
<script>
  if(location.host=='www.yunabe.jp'){
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19477574-2', 'yunabe.jp');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
  }
</script>
<script type="text/javascript" src="_static/main.js"></script>
</div>
  </body>
</html>